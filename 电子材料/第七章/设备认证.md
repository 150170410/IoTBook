# 设备认证
## 1. 基于对称密钥的设备认证
基于对称密钥进行设备认证是物联网云平台最常使用的设备身份验证方法之一。图1描述了设备与物联网云平台之间对称密钥的分发和使用流程。用户向物联网云平台添加设备时，物联网云平台将随机生成一对相同的共享对称密钥，一把存储在平台端，另一把则通过加密的传输方式，如HTTPS发送给用户。用户在编写设备程序代码时，将密钥配置到设备上。这样，当设备需要连接云平台时，将通过对称密钥加密的形式进行认证。具体来说，设备通过发送对称密钥签名的令牌给云平台进行认证。通常云平台附带有生成令牌的SDK API，在设备连接前，设备端通过调用API，使用对称密钥对设备标识、随机数或时间戳等进行加密，即可自动生成认证令牌。

<div align=center>
<img src=".\pics\pic1.png" width="50%">

图1 对称密钥的分发和使用流程
</div>

基于对称密钥的设备认证具有加解密计算量小、速度快，易于在设备端实现的特点，能够一定程度上确保设备认证安全，但是也存在对称密钥泄露的安全问题。
## 2. 基于非对称密钥的设备认证
为了进一步保证设备认证的安全性，许多物联网云平台采用了基于非对称密钥的设备认证方式。在非对称密钥身份验证的体系中，涉及一对公私钥。设备端持有私钥用于签名，而物联网云平台则通过某种途径获取公钥用于认证。  

根据公钥管理方式的不同，基于非对称密钥的设备认证又常常分为使用CA证书和使用IBC（Identity-Based Cryptograph）两类认证方法。  

在使用CA证书的设备认证方法中，为了管理公钥，通常采用基于CA证书的公钥基础设施PKI（Public Key Infrastructure）机制。以下通过简单的示例阐述使用CA证书进行设备认证的原理。假设Alice向CA机构为设备deviceA申请了一个CA证书，证书的拥有者为deviceA，证书明文内容为P_A。在证书生成时，CA机构首先生成一对密钥——私钥SK和公钥PK，随后使用SHA-1算法对P_A加密生成哈希值SHA(P_A)，最后使用私钥SK对SHA(P_A)加密，生成签名E_SK (SHA(P_A))写入证书，公钥PK则提供给云平台。如图2所示，证书的信息主要包括两部分：证书明文内容P_A和签名E_SK (SHA(P_A))。为了方便表示，本书将证书的信息表示为：P_A |E_SK (SHA(P_A))。其中，P_A表示证书的明文内容，SHA(x)表示使用SHA-1算法对内容x加密生成的哈希值，E_SK (h)表示对哈希值使用CA机构私钥SK加密生成的签名。

<div align=center>
<img src=".\pics\pic2.png" width="50%">

图2 CA证书示例
</div>

使用基于CA证书的PKI机制管理公钥，可以有效抵御一些攻击行为，如身份伪造、信息篡改和重放攻击等。假设deviceA将证书发送给云平台用于设备认证。攻击者Trudy尝试通过两种方式进行攻击：  

场景一：Trudy使非法设备deviceB发送证书给云平台，声称该证书为deviceA的证书，申请连接云平台。云平台收到的证书信息为P_B |E_SK2 (SHA(P_B))。其中SK2为Trudy伪造的CA机构的私钥。云平台将发现证书的拥有者不是deviceA，并拒绝连接请求。  

场景二：Trudy通过篡改设备公钥的方式伪造了deviceA的证书，并将伪造后的证书发送给云平台，声称该证书为deviceA的证书，申请连接云平台。云平台通过比对使用SHA-1算法对证书内容加密后的哈希值和使用CA机构提供的公钥对证书签名解密后生成的哈希值，确定证书的合法性。比对过程如以下公式所示：

<div align=center>
<img src=".\pics\pic_f1.png" width="50%">

</div>

其中，SHA(P_B)表示对伪造证书明文内容P_B使用SHA-1算法加密后的哈希值；E_SK2 (SHA(P_B))为证书的签名；D_PK (s)表示对签名s使用CA公钥PK解密生成的哈希值。由于公钥PK只能解密由对应的私钥SK加密的签名，因此对于私钥SK2加密的签名，使用公钥PK解密出的哈希值一定与SHA(P_B)不匹配，因此云平台将拒绝连接请求。  

使用基于CA证书的PKI机制管理公钥可以进一步确保云平台设备认证的安全性。目前，物联网云平台一般使用X.509格式的CA证书。X.509证书获取的方式包括以下三种：由CA机构颁发、使用物联网云平台生成以及使用第三方工具创建。图3描述了物联网云平台和设备之间使用CA架构颁发的X.509证书进行身份认证的流程。用户首先需要向CA机构为设备购买证书，CA机构将含有公钥的证书颁发给用户。用户在编写设备代码时为设备配置证书。最后，用户在云平台上添加设备后，设备与云平台之间即可通过证书传递公钥，从而进行设备认证。
 
<div align=center>
<img src=".\pics\pic3.png" width="50%">

图3 X.509证书的使用流程
</div>

通过引入基于CA证书的PKI机制管理公钥，可以有效提高物联网云平台设备认证的安全性。但是当物联网规模不断扩大后，认证过程往往涉及到大量的证书传输，造成不小的传输开销。为了简化公钥管理，一些物联网云平台采用了IBC管理公钥的方式，直接将设备标识，例如序列号、网络地址等作为公钥。图4描述了物联网云平台和设备之间使用IBC的流程。首先，用户根据设备标识信息向密钥生成中心（KGC，Key Generator Center）为设备申请私钥，密钥生成中心则通过加密的传输方式将设备私钥发送给用户。用户在编写设备程序的代码时，将收到的设备私钥配置到设备上。随后，用户向云平台添加设备后，设备与云平台之间即可使用IBC管理公钥的方式进行设备认证。
<div align=center>
<img src=".\pics\pic4.png" width="50%">

图4 IBC的使用流程
</div>