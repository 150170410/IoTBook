# 6LoWPAN
6LowPAN的主要任务是在IEEE802.15.4 MAC 层和 IPv6 网络层之间加入适配层，使得IPv6 数据包能够运行在 IEEE802.15.4 的网络上，从而完成 IEEE802.15.4 的 MAC 与 IPv6 网络层间的无缝连接。

IPv6 数据报头部长达 40 字节，而 UDP 头部也有 8 字节大小，这种头部格式减少了 MAC 层传输 IPv6 有效负载的长度，造成效率低下。因此，对其进行头部压缩十分必要。 

<div align=center>
<img src=".\pics\fig-5-ipv6报头.png" width="30%">

图5-33 IPv6数据报头部结构
</div>

图5-33给出了IPv6数据报头部结构。可以看到，源节点与目的节点的IPv6地址共占用32字节，占据了头部的大部分空间。因此，对IPv6地址的压缩十分关键。我们首先介绍经由6LoWPAN压缩后的帧结构，然后重点介绍IPv6地址压缩方法，再介绍IPv6头部其它字节压缩方法，最后介绍对UDP头部的压缩。

## 6LoWPAN帧结构
6LoWPAN对IPv6数据包头部进行压缩后，嵌入到链路层帧结构里，压缩后的帧结构如图5-34所示。其中40B的IPv6头部压缩后由2B的IPHC控制字节和长度可变的未压缩域（Inline IPv6 bits）构成。8B的UDP头部压缩后由1B的UDPHC控制字节和长度可变的未压缩域（Inline UDP bits）构成。IPHC和UDPHC控制字节分别用于说明IPv6头部和UDP头部是如何压缩的。

在压缩后的IPv6数据包前面，6LoWPAN还会为其扩展一个dispatch字节，用于说明数据包的类型。Dispactch字节说明说下（n表示0或1）：
•	00nnnnnn：表示不是LoWPAN帧；
•	01nnnnnn：表示是普通的IPv6帧；
•	10nnnnnn：表示dispatch字节后是Mesh报头；
•	11nnnnnn：表示dispatch字节后是分段报文的报头。


<div align=center>
<img src=".\pics\fig-5-6LoWPAN 链路层帧结构.png" width="80%">

图5-34 6LoWPAN 链路层帧结构
</div>

## IPv6地址压缩
IPv6地址的长度是128位，由64位前缀与64位接口标识符 (Interface ID，IID) 构成。6LoWPAN中的IPv6地址是通过组合LoWPAN的前缀和链路层地址而自动生成的。链路层地址与IPv6地址之间的直接映射关系可以用于实现压缩。

6LoWPAN中的IPv6地址前缀。常用的单播地址前缀有本地链路单播地址前缀和全球单播地址前缀。本地链路单播地址前缀为固定的“FE80::/64”。全球单播地址前缀由路由器分配，在6LoWPAN中最多支持16种前缀。

6LoWPAN中的IPv6地址IID。通常由链路层地址直接配置而成，可以直接从链路层地址推导出。IEEE 802.15.4 MAC层支持两种格式的链路层地址。符合IEEE 802.15.4标准的芯片都支持64位的全球唯一EUI-64地址，由设备的生产商所分配。EUI-64地址直接加上前缀构成IPv6地址。同时，IEEE 802.15.4还支持16位动态分配的短地址。16位短地址首先加上48位伪地址扩充为64位IID，再加上前缀构成IPv6地址。

<div align=center>
<img src=".\pics\fig-5-IPHC控制字节.png" width="80%">

图5-35 IPHC控制字节
</div>

图5-35给出了IPHC控制字节的说明，其中，IPv6地址压缩方式指示位有M、CID、SAC/DAC、SAM/DAM。
CID，SAC/DAC用于说明对地址前缀的压缩。对两种IPv6单播地址前缀区分两种压缩方式。无状态模式（SAC/DAC=0）用于压缩本地链路地址前缀，由于其值固定为FE80:/64，因此无需额外标记。基于上下文的模式（SAC/DAC=1）用于压缩全球单播地址前缀，该前缀由路由器从事先存储的16个前缀中选择，编号为0~15。CID=0，表示使用编号为的前缀；CID=1，表示前缀编号需要从紧跟在IPHC后的下一字节中读取，源地址和目的地址各用4-bit用于记录其前缀编号。图5-36给出了CID=1时，源地址和目的地址前缀编号的记录位。

<div align=center>
<img src=".\pics\fig-5-cid.png" width="80%">

图5-36 CID=1时，源地址和目的地址前缀编号记录位
</div>

M表示目的地址是单播地址还是多播地址。M=0表示单播地址，M=1表示多播地址。
SAM/DAM用于说明地址长度。00表示地址完全没有压缩，记录在未压缩域内；01表示省略掉了64位前缀；10表示省略掉了112位前缀；11表示128位地址全部省略掉了，IID从链路层推导。
可以看到，对本地链路单播地址的压缩是最好的情况，压缩程度最高，此时，IPv6地址前缀和IID都可被完全省略。

## IPv6头部其它字节压缩
版本（Version）和有效载荷长度（PayloadLen）字段可以直接省略。这是因为版本总是6，而有效载荷长度可以从报文的MAC头部中获得。

通信分类（Traffic Class）和流标签（Flow Label）字段的压缩方式由IPHC中的2位TF位来说明。这两个字段在IPv6头部中占用28位，用于QoE控制, 在传感网中基本总是0。在IPHC中，TF通常为11，表示这两个字段全零，完全省略。

跳数限制（Hop Limit）字段由HLIM位来说明。该字段表示最大跳数，在IPv6头部中占用8位。在IPHC中用2位的HLIM来表示3种类型的跳数。00表示该字段不压缩，记录在非压缩域；01表示1跳；10表示64跳；11表示255跳。

IPHC中的NH用于说明下一个头部（通常为UDP Header）有没有压缩。0表示不压缩，下一个头部存储于未压缩域；1表示有压缩。

## UDP头部压缩
UDP头部共8字节，由2字节的源端口(Source Port)，2字节的目的端口(Destination Port)，2字节的长度(Length)，和2字节的校验和（Checksum）构成。

**端口号压缩**：在6LoWPAN中规定了端口值的范围为：61616~61632，共16个值，因此端口号可以用4位来表示。

**长度字段压缩**：UDP数据报的长度可以从IPv6的长度中推出，因此可以省略该字段。

**校验和字段压缩**：如果在其他的协议（例如，IPSec）中已有校验和字段，则该字段可以省略，如果没有，则需要保留。

UDP头部压缩控制字节（UDPHC）如图5- 37所示。其中，C位用于说明对校验和的压缩方式：0表示未压缩，存储于未压缩域；1表示省略。P位用于说明端口的压缩方式：00表示未压缩，存储于未压缩域；01表示省略目的端口前8位；10表示省略源端口前8位；11表示省略源端口和目的端口前12位。

<div align=center>
<img src=".\pics\fig-5-UDPHC控制字节.png" width="50%">

图5- 37 UDPHC控制字节
</div>

## 头部压缩总结及示例
表5-9总结了6LoWPAN对IPv6头部和UDP头部字段在最好情况下的压缩效果，以及在控制字节中用于每个字段的压缩说明位。

*表5-9 6LoWPAN 头部压缩总结*


图5-38本地链路单播报文头部压缩示例。IPv6头部中的有效载荷长度（Payload Length）、源地址IID、目的地址IID可以从802.15.4链路层头部中获取，因此直接省略。IPv6头部中的其它字节在IPHC中进行说明，无需额外的字节。因此，IPv6头部压缩后只剩下2字节的IPHC控制字节。

UDP头部中长度（Length）字段直接省略。端口字段需要在UDPHC中说明其压缩方式，此外，还需要额外的1字节来记录压缩后的端口号。校验和（Checksum）字段保留下来未进行压缩。因此，UDP头部压缩后为4字节。

注意，6LoWPAN在压缩后的IPv6数据报文前面，还会扩展一个dispatch字节。因此，总的来说，经由6LoWPAN压缩，原来48字节的UDP/IPv6头部变为7字节。

<div align=center>
<img src=".\pics\fig-5-本地链路单播报头压缩示例.png" width="70%">

图5-38 本地链路单播报头压缩示例
</div>